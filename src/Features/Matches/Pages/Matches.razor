@page "/matches"
@using MagicMatchTracker.Features.Matches.Components
@inherits StatefulComponentBase<MagicMatchTracker.Features.Matches.Services.MatchListingState>

<PageTitle>Matches - Match Tracker</PageTitle>

<h1>Matches</h1>

<button class="btn btn-primary btn-fab"
        disabled="@(State.Matches is null || State.IsBusy)"
        @onclick="() => State.AddNewMatchAsync(cancellationToken: CancellationToken)">
	@if (State.IsBusy)
	{
		<span class="spinner-border spinner-border-sm m-1" aria-hidden="true"></span>
	}
	else
	{
		<span class="icon filled" aria-hidden="true">add</span>
	}
	<span>New match</span>
</button>

@if (State.Matches is null)
{
	<PageLoading/>
	return;
}

@if (State.Matches.Count == 0)
{
	<p>No matches available.</p>
	return;
}

@* TODO: Change into cards *@
<div class="list-group list-group-flush">
	@foreach (var group in State.Matches.GroupBy(m => m.GetEffectiveDate()))
	{
		<div class="list-group-item date-title sticky-top">@FormatDate(group.Key)</div>

		@foreach (var match in group)
		{
			<a class="list-group-item list-group-item-action d-flex flex-column gap-2 py-3" href="/matches/@match.Id">
				<div class="text-content match-title @GetMatchStateTextClass(match)">
					<span>@match.GetTitle(includeDate: false)</span>
				</div>

				@* Durartion *@
				<MatchDurationDisplay Match="match"/>

				@* Winner *@
				@if (match.HasEnded)
				{
					var winner = match.Participations.FirstOrDefault(mp => mp.EndState?.IsWinner is true);
					<div class="text-content">
						<span class="icon">trophy</span>
						@if (winner is not null)
						{
							<span class="me-0.5">Winner:</span>
							<Avatar Player="winner.Player" Size="20"/>
							<span>@winner.Player.Name</span>
						}
						else
						{
							<span>Draw</span>
						}
					</div>
				}

				@* Notes *@
				@if (match.Notes is not null)
				{
					<div class="text-content">
						<span class="icon">sticky_note_2</span>
						<span>@match.Notes</span>
					</div>
				}

				@* Players *@
				@if (match.Participations.Count > 0)
				{
					var players = match.Participations
						.Select(mp => mp.Player)
						.OrderBy(p => p.Name)
						.ToList();

					<div class="d-flex align-items-center" title="@players.Select(p => p.Name).JoinToString(", ")">
						@foreach (var player in players)
						{
							<Avatar Player="player" Size="20" class="avatar-overlap"/>
						}
						<span class="ms-1">@match.Participations.Count players</span>
					</div>
				}
			</a>
		}
	}
</div>

<MatchPlayerSelectDialog/>

@code {

	protected override async Task OnInitializedAsync()
	{
		await State.LoadMatchesAsync(CancellationToken);
	}

	private string? GetMatchStateTextClass(Match match)
	{
		if (!match.HasStarted)
			return "text-secondary";

		if (match.IsInProgress)
			return "text-primary";

		return null;
	}

	private string FormatDate(DateOnly date)
	{
		var today = DateTimeOffset.Now.ToDateOnly();

		if (date == today)
			return "Today";

		if (date == today.AddDays(-1))
			return "Yesterday";

		if (date.Year == today.Year)
			return date.ToString("dddd, dd MMMM");

		return date.ToString("dd MMMM yyyy");
	}

}